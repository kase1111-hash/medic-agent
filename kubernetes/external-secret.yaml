# Medic Agent - External Secret
# Phase 7: Deployment & Operations
#
# Uses the external-secrets operator to fetch secrets from a secrets manager
# Supports AWS Secrets Manager, HashiCorp Vault, Azure Key Vault, GCP Secret Manager
#
# Prerequisites:
#   1. Install external-secrets operator: https://external-secrets.io/
#   2. Configure a SecretStore or ClusterSecretStore
#   3. Create the secrets in your secrets manager
#
# Usage:
#   Replace secret.yaml with this file in kustomization.yaml for production
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: medic-agent-secrets
  namespace: medic-agent
  labels:
    app.kubernetes.io/name: medic-agent
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: cluster-secret-store  # Reference to your ClusterSecretStore
    kind: ClusterSecretStore
  target:
    name: medic-agent-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: medic-agent
          app.kubernetes.io/component: secrets
  data:
    # SIEM API Key - fetched from secrets manager
    - secretKey: SIEM_API_KEY
      remoteRef:
        key: medic-agent/siem-api-key  # Path in your secrets manager
        property: api_key              # Property name (if using JSON secrets)

    # Redis password (uncomment if needed)
    # - secretKey: REDIS_PASSWORD
    #   remoteRef:
    #     key: medic-agent/redis
    #     property: password

---
# Alternative: SecretStore for namespace-scoped secrets
# Uncomment and configure for your secrets provider
#
# apiVersion: external-secrets.io/v1beta1
# kind: SecretStore
# metadata:
#   name: medic-secret-store
#   namespace: medic-agent
# spec:
#   provider:
#     # AWS Secrets Manager example:
#     aws:
#       service: SecretsManager
#       region: us-west-2
#       auth:
#         jwt:
#           serviceAccountRef:
#             name: medic-agent
#
#     # HashiCorp Vault example:
#     # vault:
#     #   server: "https://vault.example.com"
#     #   path: "secret"
#     #   version: "v2"
#     #   auth:
#     #     kubernetes:
#     #       mountPath: "kubernetes"
#     #       role: "medic-agent"
#
#     # Azure Key Vault example:
#     # azurekv:
#     #   vaultUrl: "https://medic-kv.vault.azure.net"
#     #   authType: ManagedIdentity
